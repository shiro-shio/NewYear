<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>2025 Anime Style Fireworks</title>

<!-- 2D ç²’å­ç…™ç« -->
<script src="https://unpkg.com/fireworks-js@2.x/dist/index.umd.js"></script>

<!-- Three.js -->
<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>

<style>
/* ========================
   å…¨åŸŸæ¨£å¼
======================== */
:root {
    --bg: #000;
    --text: #fff;
    --panel: rgba(255,255,255,0.12);
}
body.light {
    --bg: #f0f0f0;
    --text: #000;
    --panel: rgba(0,0,0,0.15);
}
html,body {
    margin:0;
    width:100%;
    height:100%;
    overflow:hidden;
    background:var(--bg);
    color:var(--text);
    font-family:sans-serif;
}

/* ========================
   Layer åˆ†å±¤
======================== */
#fw2d {
    position:fixed;
    inset:0;
    z-index:1;
}
#ui {
    position:relative;
    z-index:10;
    padding:20px;
}
.panel {
    background:var(--panel);
    backdrop-filter: blur(10px);
    padding:15px;
    border-radius:12px;
}
#countdown {
    text-align:center;
    font-size:3rem;
    margin-bottom:20px;
}
.hidden { display:none; }
button { cursor:pointer; }
</style>
</head>

<body>

<!-- ========================
     2D Fireworks å®¹å™¨
======================== -->
<div id="fw2d"></div>

<!-- ========================
     UI
======================== -->
<div id="ui">
    <div id="countdown">00:00:00</div>

    <div class="panel" id="panel">
        <button onclick="toggleTheme()">é»‘ / ç™½åˆ‡æ›</button>
        <button onclick="toggleUI()">éš±è— UI (H)</button>
        <button onclick="manualLaunch()">æ‰‹å‹•ç…™ç«</button>
        <br><br>

        æ™‚å€ï¼š
        <select id="timezone"></select>
        <br><br>

        è‡ªå‹•ç…™ç«ç§’æ•¸ï¼š
        <input type="number" id="duration" value="10" min="1" style="width:60px;">
    </div>
</div>

<script>
/* =====================================================
   ã€æ¨¡çµ„ 1ã€‘fireworks-jsï¼ˆ2D èƒŒæ™¯ç…™ç«ï¼‰
===================================================== */
const fw2d = new Fireworks.default(
    document.getElementById("fw2d"),
    {
        opacity:0.5,
        acceleration:1.05,
        friction:0.97,
        gravity:1.5,
        particles:80,
        intensity:30,
        flicker:true
    }
);

/* =====================================================
   ã€æ¨¡çµ„ 2ã€‘Three.js å‹•æ¼«é¢¨ç…™ç«ï¼ˆæ ¸å¿ƒï¼‰
===================================================== */
let scene, camera, renderer;
let animeFireworks = [];

/* åˆå§‹åŒ– Three.js */
function initAnimeFireworks(){
    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth/window.innerHeight,
        1,
        500
    );
    camera.position.z = 120;

    renderer = new THREE.WebGLRenderer({
        alpha:true,
        antialias:true
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.domElement.style.position = "fixed";
    renderer.domElement.style.inset = 0;
    renderer.domElement.style.zIndex = 3;
    document.body.appendChild(renderer.domElement);

    window.addEventListener("resize", ()=>{
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animateAnimeFireworks();
}

/* å»ºç«‹ä¸€ç™¼å‹•æ¼«ç…™ç« */
function createAnimeFirework(){
    const count = 700;
    const geo = new THREE.BufferGeometry();
    const pos = new Float32Array(count*3);
    const vel = new Float32Array(count*3);
    const col = new Float32Array(count*3);

    const hue = Math.random()*360;

    for(let i=0;i<count;i++){
        const i3=i*3;
        pos[i3]=pos[i3+1]=pos[i3+2]=0;

        const theta=Math.random()*Math.PI*2;
        const phi=Math.acos(Math.random()*2-1);
        const speed=Math.random()*2+2;

        vel[i3]=Math.sin(phi)*Math.cos(theta)*speed;
        vel[i3+1]=Math.cos(phi)*speed;
        vel[i3+2]=Math.sin(phi)*Math.sin(theta)*speed;

        const c=new THREE.Color(`hsl(${hue+Math.random()*40},100%,70%)`);
        col[i3]=c.r; col[i3+1]=c.g; col[i3+2]=c.b;
    }

    geo.setAttribute("position", new THREE.BufferAttribute(pos,3));
    geo.setAttribute("velocity", new THREE.BufferAttribute(vel,3));
    geo.setAttribute("color", new THREE.BufferAttribute(col,3));

    const mat = new THREE.PointsMaterial({
        size:1.8,
        vertexColors:true,
        transparent:true,
        opacity:1,
        blending:THREE.AdditiveBlending,
        depthWrite:false
    });

    const points = new THREE.Points(geo,mat);
    points.position.set(
        (Math.random()-0.5)*80,
        (Math.random()-0.5)*40,
        (Math.random()-0.5)*40
    );

    scene.add(points);
    animeFireworks.push({mesh:points, life:120});
}

/* Three.js å‹•ç•«å¾ªç’° */
function animateAnimeFireworks(){
    requestAnimationFrame(animateAnimeFireworks);

    animeFireworks.forEach((fw,i)=>{
        const p=fw.mesh.geometry.attributes.position.array;
        const v=fw.mesh.geometry.attributes.velocity.array;

        for(let j=0;j<p.length;j+=3){
            p[j]+=v[j];
            p[j+1]+=v[j+1];
            p[j+2]+=v[j+2];
            v[j+1]-=0.02;
            v[j]*=0.985; v[j+1]*=0.985; v[j+2]*=0.985;
        }

        fw.mesh.geometry.attributes.position.needsUpdate=true;
        fw.mesh.material.opacity-=0.008;
        fw.life--;

        if(fw.life<=0){
            scene.remove(fw.mesh);
            animeFireworks.splice(i,1);
        }
    });

    renderer.render(scene,camera);
}

/* =====================================================
   ã€æ¨¡çµ„ 3ã€‘å€’æ•¸è¨ˆæ™‚ï¼ˆæ™‚å€å®‰å…¨ï¼‰
===================================================== */
function nowInTZ(tz){
    return new Date(new Date().toLocaleString("en-US",{timeZone:tz}));
}

function updateTime(){
    const tz=timezone.value;
    const now=nowInTZ(tz);
    const target=new Date(now.getFullYear()+1,0,1);
    const diff=target-now;

    if(diff<=0){
        countdown.innerText="ğŸ† HAPPY NEW YEAR ğŸ†";
        startAutoFireworks();
        return;
    }

    const h=String(diff/3600000|0).padStart(2,"0");
    const m=String(diff%3600000/60000|0).padStart(2,"0");
    const s=String(diff%60000/1000|0).padStart(2,"0");
    countdown.innerText=`${h}:${m}:${s}`;
}

/* =====================================================
   ã€æ¨¡çµ„ 4ã€‘æ“ä½œæ•´åˆå…¥å£
===================================================== */
function manualLaunch(){
    fw2d.launch(2);
    createAnimeFirework();
}

function startAutoFireworks(){
    const ms=duration.value*1000;
    fw2d.start();
    const t=setInterval(createAnimeFirework,400);
    setTimeout(()=>{
        fw2d.stop();
        clearInterval(t);
    },ms);
}

function toggleTheme(){ document.body.classList.toggle("light"); }
function toggleUI(){
    panel.classList.toggle("hidden");
    countdown.classList.toggle("hidden");
}

/* =====================================================
   åˆå§‹åŒ–
===================================================== */
["Asia/Taipei","UTC","Asia/Tokyo","America/New_York"]
.forEach(z=>timezone.add(new Option(z,z)));
timezone.value="Asia/Taipei";

initAnimeFireworks();
setInterval(updateTime,1000);

window.addEventListener("keydown",e=>{
    if(e.key.toLowerCase()==="h") toggleUI();
});
</script>

</body>
</html>
